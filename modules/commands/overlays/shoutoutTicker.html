<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Twitch API Overlay</title>
		<link rel="stylesheet" href="style.css">
		
		<!-- Load the Twitch embed script -->
		<script src="https://embed.twitch.tv/embed/v1.js"></script>
        <script src="https://thebarkingotter.com/gameworks/HtmlUtility.js"></script>
        <script src="https://thebarkingotter.com/gameworks/TwitchAPI.js"></script>
        <script src= "https://player.twitch.tv/js/embed/v1.js"></script>
        <script type="text/javascript">

            const POLL_INTERVAL = 1;
            const SHOUTOUT_DURATION = 10;
            const DOWN_TIME = 10;
            //const DAYS_SINCE_LAST_STREAM_THRESHOLD = 14;


            const CLIENT_ID = "rat7tckwdp2962ahwqlorv2qg4lzcr";
            const QUERIES = {
                shoutout: {
                    frequency: 0,
                    function: Shoutout
                }
            };

            let doShowClip = true;

            let debug = false;

            let tickerHeight = 80;
            let tickerWidth = 1080;

            let streamersFollows = null;

            let lastChange = Date.now();

            async function Init()
            {

                ParseUrl();

                accessToken = FindKeyValuePair(thisUrl, "token");
                if(accessToken == null)
                    return;

                InitTwitchApi(CLIENT_ID, accessToken, QUERIES);

                tickerHeight = GetOrFallback("height", tickerHeight);
                tickerWidth = GetOrFallback("width", tickerWidth);

                let div = document.getElementById("shoutout");
                div.style.height = tickerHeight.toString() + "px";
                div.style.width = tickerWidth.toString() + "px";

                let pfpDiameter = tickerHeight - 10;
                let pfpCircle = document.getElementById("pfpCircle");
                pfpCircle.style.width = pfpDiameter.toString() + "px";
                pfpCircle.style.height = pfpDiameter.toString() + "px";

                if(GetOrFallback("debug", false) != false)
                {
                    debug = true;

                    let shoutoutDiv = document.getElementById("shoutout");
                    shoutoutDiv.style.display = "block";

                    let channel = GetOrFallback("channel", null);
                    if(channel != null)
                    {
                        Shoutout();
                    }
                }

                // do checks at long intervals
                setInterval(Tick, (POLL_INTERVAL) * 1000);
            
                channel = GetOrFallback("channel", null);
                if(channel != null)
                    streamersFollows = await GetFollowsByUserAsync(channel);
            }

            function Tick()
            {
                RequestFile("overlay.json", OnLoadFile);
            }

            function OnLoadFile()
            {
                let json = JSON.parse(request.response);

                let chatters = json.chatters;
                for(let chatter in chatters)
                {
                    // loop through
                    // see who's a streamer
                    // get last stream date
                    // see if it's recent
                }




                

                // if a shoutout was created recently, perform it
                if(lastChange < json.twitchAPI.time)
                {
                    channel = json.twitchAPI.channel;
                    if(channel == null || channel == undefined || channel == "")
                    {
                        return;
                    }

                    queryName = json.twitchAPI.query;
                    if(queryName == null || queryName == undefined || queryName == "")
                    {
                        return;
                    }

                    //doShowClip = json.twitchAPI.doShowClip;

                    // actually perform the query (TwitchApi.js)
                    IdentifyAndPerformQuery();

                    lastChange = json.twitchAPI.time;
                }

                
            }

            async function Shoutout()
            {
                await PopulateDisplayName(channel, "user");

                await PopulateProfilePic(channel, "profilePic");

                let categoryWrapper = await PopulateLastCategory(channel, "category");

                let shoutoutDiv = document.getElementById("shoutout");
                shoutoutDiv.style.display = "block";

                let titleWrapper = null;
                let emoteTags = [];
                let emotesWrapper = null;

                if(categoryWrapper != null)
                {
                    await PopulateTitle(channel, "title");
                    titleWrapper = document.getElementById("titleWrapper");
                    emotesWrapper = document.getElementById("emoteWrapper");

                    emoteTags = await PopulateEmotes(channel, "emotes");
                    if(emoteTags.length > 0)
                    {
                        emotesWrapper.style.display = "flex";
                    }
                    else
                    {
                        emotesWrapper.style.display = "none";
                    }

                    if(debug == true)
                        return;

                    await Pause(SHOUTOUT_DURATION * 1000);
                   
                    shoutoutDiv.style.display = "none";

                    for(let prop in emoteTags)
                    {
                        // remove from rendering
                        emoteTags[prop].remove();
                    }
                }
            }

        </script>
		
	</head>



    <body onload="Init()">
        <!--Div containing everything-->
        <div id="shoutout" class="Blocky" style="display:none; left: 10px; position:relative; font-size:small">
            <!-- outer table-->
            <table>
                <tr>
                    <!-- username -->
                    <td>
                        <div id="user" class="Biggest" style="color:cyan;">abcdefghijklmnopqrstuvwxy</div>
                    </td>
                    <!-- profile pic-->
                    <td>
                        <div id="pfpCircle" class="Circle" style="background-color:green; border:solid green">
                            <img id="profilePic" style="height:100%"/>
                        </div>
                    </td>
                    <!-- title , category, emotes-->
                    <td>
                        <table>
                            <tr>
                                <!-- title -->
                                <td>
                                    <div style="align-self:center; margin:5px;">Last seen playing:</div> 
                                </td>
                                <td>
                                    <div id="category" style="color:cyan;"></div>
                                </td>
                                <!-- category -->
                                <td>
                                    <div style="align-self:center; margin:5px;">Most recent title: </div> 
                                </td>
                                <td>
                                    <div id="title" style="color:cyan;"></div>
                                </td>
                            </tr>
                        </table>
                        <!-- emotes -->
                        <div id="emoteWrapper" style="display:flex;">
                            <div style="align-self:center; margin:5px;">Emotes: </div> 
                            <div id="emotes" style="color:cyan;"></div>
                        </div>
                    </td>
                </tr>
            </table>
            

        </div>

    </body>


</html>